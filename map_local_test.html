<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OASIS â€” Ghana Healthcare Intelligence</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.9.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.9.0/mapbox-gl.css' rel='stylesheet' />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        :root {
            --accent: #FF6B35;
            --accent-glow: rgba(255,107,53,0.4);
            --accent-soft: rgba(255,107,53,0.15);
            --cyan: #00D4FF;
            --green: #00E676;
            --red: #FF5252;
            --yellow: #FFD740;
            --glass: rgba(10,12,20,0.82);
            --glass-border: rgba(255,255,255,0.08);
            --t1: #fff;
            --t2: rgba(255,255,255,0.6);
            --t3: rgba(255,255,255,0.35);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',system-ui,sans-serif; overflow:hidden; background:#000; }
        #map { position:absolute; inset:0; }

        /* â”€â”€ Glass panels â”€â”€ */
        .glass {
            background: var(--glass);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
        }

        /* â”€â”€ Top bar â”€â”€ */
        .top-bar {
            position:absolute; top:20px; left:50%; transform:translateX(-50%);
            z-index:1000; padding:12px 28px;
            display:flex; align-items:center; gap:12px;
        }
        .top-bar .logo {
            width:32px; height:32px;
            background:linear-gradient(135deg,var(--accent),#FF8F6B);
            border-radius:8px; display:flex; align-items:center; justify-content:center;
            font-size:18px;
        }
        .top-bar h1 { font-size:18px; font-weight:700; color:var(--t1); letter-spacing:2px; }
        .top-bar .sub { font-size:11px; color:var(--t2); letter-spacing:0.5px; }
        .status-dot {
            width:8px; height:8px; border-radius:50%; background:var(--green); margin-left:8px;
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%,100%{box-shadow:0 0 0 0 rgba(0,230,118,0.7)} 50%{box-shadow:0 0 0 6px rgba(0,230,118,0)}
        }

        /* â”€â”€ Left sidebar â”€â”€ */
        .sidebar {
            position:absolute; top:80px; left:20px; width:340px; z-index:1000;
            max-height:calc(100vh - 100px); overflow-y:auto;
            scrollbar-width:thin; scrollbar-color:rgba(255,255,255,0.1) transparent;
        }
        .sidebar::-webkit-scrollbar{width:4px}
        .sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:2px}

        .section { padding:20px; }
        .section + .section { border-top:1px solid var(--glass-border); }
        .section-label {
            font-size:10px; font-weight:700; text-transform:uppercase;
            letter-spacing:1.5px; color:var(--t3); margin-bottom:12px;
        }
        .section-title { font-size:16px; font-weight:700; color:var(--t1); margin-bottom:4px; }
        .section-desc { font-size:12px; color:var(--t2); line-height:1.5; margin-bottom:16px; }

        /* â”€â”€ Inputs â”€â”€ */
        .select-wrap { position:relative; margin-bottom:12px; }
        .select-wrap select {
            width:100%; padding:12px 16px;
            background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
            border-radius:10px; color:var(--t1); font-size:14px; font-family:inherit;
            outline:none; appearance:none; cursor:pointer; transition:all 0.3s;
        }
        .select-wrap select:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-soft); }
        .select-wrap select option { background:#1a1a2e; color:#fff; }
        .select-wrap::after { content:'â–¾'; position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--t3); pointer-events:none; }

        .input-wrap { position:relative; margin-bottom:12px; }
        .input-wrap input {
            width:100%; padding:12px 16px 12px 38px;
            background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
            border-radius:10px; color:var(--t1); font-size:14px; font-family:inherit;
            outline:none; transition:all 0.3s;
        }
        .input-wrap input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-soft); }
        .input-wrap input::placeholder { color:var(--t3); }
        .input-wrap .icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:14px; color:var(--t3); }

        .range-row { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
        .range-row label { font-size:11px; color:var(--t2); white-space:nowrap; }
        .range-row input[type=range] {
            flex:1; -webkit-appearance:none; height:4px;
            background:rgba(255,255,255,0.1); border-radius:2px; outline:none;
        }
        .range-row input[type=range]::-webkit-slider-thumb {
            -webkit-appearance:none; width:18px; height:18px;
            background:var(--accent); border-radius:50%; cursor:pointer;
            box-shadow:0 0 8px var(--accent-glow);
        }
        .range-val { min-width:50px; text-align:right; font-size:14px; font-weight:600; color:var(--accent); }

        /* â”€â”€ Buttons â”€â”€ */
        .btn-primary {
            width:100%; padding:14px;
            background:linear-gradient(135deg,var(--accent),#FF8F6B);
            color:#fff; border:none; border-radius:10px;
            font-size:14px; font-weight:700; font-family:inherit;
            cursor:pointer; transition:all 0.3s;
            display:flex; align-items:center; justify-content:center; gap:8px;
            letter-spacing:0.5px; text-transform:uppercase;
        }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 8px 24px var(--accent-glow); }
        .btn-primary:disabled { opacity:0.5; cursor:wait; transform:none; }

        .btn-sm {
            padding:10px; background:rgba(255,255,255,0.06);
            color:var(--t2); border:1px solid rgba(255,255,255,0.1);
            border-radius:8px; font-size:12px; font-weight:600;
            font-family:inherit; cursor:pointer; transition:all 0.3s;
        }
        .btn-sm:hover { background:rgba(255,255,255,0.1); color:var(--t1); }

        /* â”€â”€ Result cards â”€â”€ */
        .result-card {
            padding:14px; background:rgba(255,255,255,0.03);
            border:1px solid rgba(255,255,255,0.06);
            border-radius:12px; margin-bottom:10px;
            cursor:pointer; transition:all 0.3s; position:relative;
        }
        .result-card:hover { background:rgba(255,255,255,0.06); border-color:var(--accent); transform:translateX(4px); }
        .result-card.active { border-color:var(--accent); background:var(--accent-soft); }
        .result-card .rank {
            position:absolute; top:-8px; left:-8px;
            width:28px; height:28px;
            background:linear-gradient(135deg,var(--accent),#FF8F6B);
            border-radius:50%; display:flex; align-items:center; justify-content:center;
            font-size:12px; font-weight:800; color:#fff;
            box-shadow:0 2px 8px var(--accent-glow);
        }
        .result-card .name { font-size:14px; font-weight:600; color:var(--t1); margin-bottom:4px; padding-left:18px; }
        .result-card .meta { font-size:11px; color:var(--t2); display:flex; gap:12px; margin-bottom:8px; }
        .match-bar { height:4px; background:rgba(255,255,255,0.06); border-radius:2px; overflow:hidden; }
        .match-fill { height:100%; border-radius:2px; transition:width 1s ease; }
        .match-label { display:flex; justify-content:space-between; margin-bottom:4px; }
        .match-label span:first-child { font-size:10px; color:var(--t3); text-transform:uppercase; letter-spacing:1px; }
        .match-label span:last-child { font-size:12px; font-weight:700; }
        .tags { display:flex; flex-wrap:wrap; gap:4px; margin-top:8px; }
        .tag {
            padding:2px 8px; background:rgba(0,212,255,0.1);
            border:1px solid rgba(0,212,255,0.2); border-radius:4px;
            font-size:9px; color:var(--cyan); text-transform:uppercase; letter-spacing:0.5px;
        }

        /* â”€â”€ Bottom detail card â”€â”€ */
        .detail-card {
            position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
            width:min(800px, calc(100% - 400px)); z-index:1000;
            display:none; overflow:hidden;
        }
        .detail-card.show { display:block; animation:slideUp 0.4s ease; }
        @keyframes slideUp { from{transform:translateX(-50%) translateY(20px);opacity:0} to{transform:translateX(-50%) translateY(0);opacity:1} }

        .detail-header {
            padding:16px 20px; display:flex; justify-content:space-between; align-items:flex-start;
            border-bottom:1px solid var(--glass-border);
        }
        .detail-header h2 { font-size:18px; font-weight:700; color:var(--t1); }
        .type-badge {
            padding:4px 12px; background:var(--accent-soft);
            border:1px solid rgba(255,107,53,0.3); border-radius:20px;
            font-size:11px; font-weight:600; color:var(--accent);
            text-transform:uppercase; letter-spacing:0.5px;
        }
        .close-btn {
            width:28px; height:28px; background:rgba(255,255,255,0.06);
            border:none; border-radius:6px; color:var(--t2); font-size:16px;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
        }
        .close-btn:hover { background:rgba(255,255,255,0.1); color:var(--t1); }

        .detail-stats {
            padding:16px 20px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px;
        }
        .stat-block { text-align:center; }
        .stat-val { font-size:28px; font-weight:800; color:var(--t1); }
        .stat-lbl { font-size:10px; color:var(--t3); text-transform:uppercase; letter-spacing:1px; margin-top:2px; }
        .detail-caps {
            padding:12px 20px 16px; border-top:1px solid var(--glass-border);
        }
        .detail-caps h4 { font-size:10px; color:var(--t3); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
        .cap-chips { display:flex; flex-wrap:wrap; gap:6px; }
        .cap-chip {
            padding:4px 10px; background:rgba(0,212,255,0.08);
            border:1px solid rgba(0,212,255,0.15); border-radius:6px;
            font-size:11px; color:var(--cyan);
        }

        /* â”€â”€ Layer toggles â”€â”€ */
        .layers {
            position:absolute; bottom:20px; right:20px; z-index:1000;
            display:flex; flex-direction:column; gap:8px;
        }
        .layer-btn {
            width:44px; height:44px; border-radius:12px;
            display:flex; align-items:center; justify-content:center;
            font-size:18px; cursor:pointer; border:none; position:relative;
            color:var(--t2); background:var(--glass);
            backdrop-filter:blur(24px); border:1px solid var(--glass-border);
            transition:all 0.3s;
        }
        .layer-btn:hover { background:rgba(255,255,255,0.1); color:var(--t1); transform:scale(1.1); }
        .layer-btn.on { background:var(--accent-soft); border-color:var(--accent); color:var(--accent); }
        .layer-btn .tip {
            position:absolute; right:56px; background:var(--glass); border:1px solid var(--glass-border);
            padding:6px 12px; border-radius:8px; font-size:11px; white-space:nowrap;
            opacity:0; pointer-events:none; transition:opacity 0.2s; color:var(--t2);
        }
        .layer-btn:hover .tip { opacity:1; }

        /* â”€â”€ Heatmap legend â”€â”€ */
        .legend {
            position:absolute; bottom:70px; right:20px; z-index:999;
            padding:12px 16px; display:none;
        }
        .legend.show { display:block; }
        .legend h4 { font-size:10px; color:var(--t3); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
        .legend-bar {
            width:160px; height:8px; border-radius:4px;
            background:linear-gradient(90deg,rgba(0,0,0,0) 0%,#1a0530 15%,#6b0f6b 30%,#ff4444 50%,#ff9944 70%,#ffee44 85%,#fff 100%);
            margin-bottom:4px;
        }
        .legend-labels { display:flex; justify-content:space-between; font-size:9px; color:var(--t3); }

        /* â”€â”€ Stats bar â”€â”€ */
        .stats-bar {
            position:absolute; bottom:20px; left:380px; z-index:999;
            padding:8px 16px; display:flex; gap:20px; font-size:11px;
        }
        .stats-bar .s { display:flex; align-items:center; gap:6px; color:var(--t2); }
        .stats-bar .n { font-weight:700; color:var(--t1); }

        /* â”€â”€ Loading â”€â”€ */
        .loader {
            position:fixed; inset:0; background:#000; z-index:9999;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            transition:opacity 1s;
        }
        .loader.gone { opacity:0; pointer-events:none; }
        .loader-icon {
            width:64px; height:64px;
            background:linear-gradient(135deg,var(--accent),#FF8F6B);
            border-radius:16px; display:flex; align-items:center; justify-content:center;
            font-size:32px; margin-bottom:24px; animation:spin 2s ease infinite;
        }
        @keyframes spin { 0%,100%{transform:rotateY(0)} 50%{transform:rotateY(180deg)} }
        .loader-text { font-size:14px; color:var(--t2); letter-spacing:3px; text-transform:uppercase; }
        .loader-bar { width:200px; height:2px; background:rgba(255,255,255,0.1); border-radius:1px; margin-top:16px; overflow:hidden; }
        .loader-fill { height:100%; background:linear-gradient(90deg,var(--accent),#FF8F6B); border-radius:1px; animation:loadbar 2s ease forwards; }
        @keyframes loadbar { from{width:0} to{width:100%} }

        /* â”€â”€ Mapbox overrides â”€â”€ */
        .mapboxgl-ctrl-bottom-left,.mapboxgl-ctrl-bottom-right{display:none}
        .mapboxgl-popup-content {
            background:var(--glass)!important; backdrop-filter:blur(24px);
            color:var(--t1)!important; border:1px solid var(--glass-border);
            border-radius:12px!important; padding:16px!important;
            box-shadow:0 8px 32px rgba(0,0,0,0.5)!important; min-width:200px;
        }
        .mapboxgl-popup-tip { border-top-color:var(--glass)!important; }
        .mapboxgl-popup-close-button { color:var(--t2)!important; font-size:18px!important; }

        /* â”€â”€ Status message â”€â”€ */
        .api-status {
            position:absolute; top:80px; right:20px; z-index:1000;
            padding:8px 14px; font-size:11px; display:none;
        }
        .api-status.show { display:flex; align-items:center; gap:8px; }
        .api-status.ok { color:var(--green); }
        .api-status.err { color:var(--red); }
    </style>
</head>
<body>

<div class="loader" id="loader">
    <div class="loader-icon">ğŸŒ</div>
    <div class="loader-text">Initializing OASIS</div>
    <div class="loader-bar"><div class="loader-fill"></div></div>
</div>

<div id="map"></div>

<!-- Top bar -->
<div class="top-bar glass">
    <div class="logo">ğŸŒ</div>
    <div>
        <h1>OASIS</h1>
        <div class="sub">Ghana Healthcare Intelligence Platform</div>
    </div>
    <div class="status-dot" id="status-dot"></div>
</div>

<!-- API status indicator -->
<div class="api-status glass" id="api-status"></div>

<!-- Left sidebar -->
<div class="sidebar glass" id="sidebar">
    <div class="section">
        <div class="section-label">Geospatial Search</div>
        <div class="section-title">Find Healthcare Facilities</div>
        <div class="section-desc">Powered by MCP geospatial tools â€” queries DuckDB with Haversine distance filtering</div>

        <div class="select-wrap">
            <select id="inp-condition">
                <option value="">Select conditionâ€¦</option>
            </select>
        </div>

        <div class="input-wrap">
            <span class="icon">ğŸ“</span>
            <input type="text" id="inp-location" placeholder="Location (e.g. Accra, Kumasi)" value="Accra" />
        </div>

        <div class="range-row">
            <label>Radius</label>
            <input type="range" id="inp-radius" min="10" max="300" value="50" />
            <span class="range-val" id="radius-display">50 km</span>
        </div>

        <button class="btn-primary" id="btn-search" onclick="doSearch()">
            <span>âš¡</span> Find Facilities
        </button>
        
        <button class="btn-sm" onclick="resetGlobe()" style="width:100%; margin-top:8px;">
            âœ• Clear Filters
        </button>
    </div>

    <!-- Coverage gaps button -->
    <div class="section">
        <div class="section-label">Coverage Analysis</div>
        <button class="btn-primary" id="btn-gaps" onclick="doGaps()" style="background:linear-gradient(135deg,#FF5252,#FF8A80);">
            <span>ğŸœï¸</span> Find Medical Deserts
        </button>
    </div>

    <!-- Results -->
    <div class="section" id="results-section" style="display:none;">
        <div class="section-label" id="results-label">Results</div>
        <div id="results-list"></div>
    </div>

    <!-- Quick nav -->
    <div class="section">
        <div class="section-label">Navigate</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button class="btn-sm" onclick="flyTo(-0.187,5.6037,13,'Accra')">ğŸ“ Accra</button>
            <button class="btn-sm" onclick="flyTo(-1.6163,6.6885,13,'Kumasi')">ğŸ“ Kumasi</button>
            <button class="btn-sm" onclick="flyTo(-0.8393,9.4008,12,'Tamale')">ğŸ“ Tamale</button>
            <button class="btn-sm" onclick="resetGlobe()">ğŸŒ Globe</button>
        </div>
    </div>
</div>

<!-- Bottom detail -->
<div class="detail-card glass" id="detail-card">
    <div class="detail-header">
        <div>
            <h2 id="d-name">â€”</h2>
            <span class="type-badge" id="d-type">â€”</span>
        </div>
        <button class="close-btn" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="detail-stats">
        <div class="stat-block"><div class="stat-val" id="d-specs">â€”</div><div class="stat-lbl">Specialties</div></div>
        <div class="stat-block"><div class="stat-val" id="d-dist">â€”</div><div class="stat-lbl">Distance</div></div>
        <div class="stat-block"><div class="stat-val" id="d-city">â€”</div><div class="stat-lbl">City</div></div>
    </div>
    <div class="detail-caps">
        <h4>Capabilities</h4>
        <div class="cap-chips" id="d-caps"></div>
    </div>
</div>

<!-- Layer toggles -->
<div class="layers">
    <button class="layer-btn on" id="tog-markers" onclick="toggleLayer('markers')">ğŸ“<span class="tip">Facility Markers</span></button>
    <button class="layer-btn" id="tog-heatmap" onclick="toggleLayer('heatmap')">ğŸ”¥<span class="tip">Coverage Heatmap</span></button>
    <button class="layer-btn" id="tog-buildings" onclick="toggleLayer('buildings')">ğŸ¢<span class="tip">3D Buildings</span></button>
    <button class="layer-btn" id="tog-deserts" onclick="toggleLayer('deserts')">ğŸœï¸<span class="tip">Medical Deserts</span></button>
</div>

<!-- Heatmap legend -->
<div class="legend glass" id="heatmap-legend">
    <h4>Healthcare Capability Density</h4>
    <div class="legend-bar"></div>
    <div class="legend-labels"><span>Desert</span><span>Low</span><span>Moderate</span><span>High</span></div>
</div>

<!-- Stats bar -->
<div class="stats-bar glass" id="stats-bar">
    <div class="s"><span>ğŸ¥</span><span class="n" id="st-total">0</span> Facilities</div>
    <div class="s"><span>ğŸ“</span><span class="n" id="st-cities">0</span> Cities</div>
    <div class="s"><span>ğŸ”¬</span><span class="n" id="st-specs">0</span> Specialties</div>
</div>

<!-- ElevenLabs Conversational AI Avatar Widget -->
<script src="https://elevenlabs.io/convai-widget/index.js" async type="text/javascript"></script>
<elevenlabs-convai agent-id="5fb47760b0b22b63d689754639894c80b823ed971ff73ced808b98563e1447ce"></elevenlabs-convai>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAPBOX_TOKEN = 'pk.eyJ1IjoicmFqbmFmIiwiYSI6ImNtbGN3cm1uMzExd3czZnI0OGVleW9iNnYifQ.xbDfYFsP0nLZtcltzMzVTw';
const API_BASE = '';  // same origin when served by map_api.py
const ELEVENLABS_API_KEY = 'sk_8edfc5ce468756b30944fd0074da83ba789b86cdae1d8d65';
const ELEVENLABS_AGENT_ID = '5fb47760b0b22b63d689754639894c80b823ed971ff73ced808b98563e1447ce';

mapboxgl.accessToken = MAPBOX_TOKEN;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let facilitiesGeoJSON = null;
let activeMarkers = [];
let searchResultsCache = [];
let layerState = { markers: true, heatmap: false, buildings: false, deserts: false };
let current3DModel = null;
let audioElement = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    projection: 'globe',
    center: [0, 20],
    zoom: 1.8,
    pitch: 0,
    bearing: 0,
    antialias: true,
});

map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');

map.on('style.load', () => {
    map.setFog({
        color: 'rgb(10,10,30)',
        'high-color': 'rgb(30,50,120)',
        'horizon-blend': 0.08,
        'space-color': 'rgb(5,5,15)',
        'star-intensity': 0.95,
    });
});

map.on('load', async () => {
    // 3D terrain
    map.addSource('mapbox-dem', { type: 'raster-dem', url: 'mapbox://mapbox.mapbox-terrain-dem-v1', tileSize: 512, maxzoom: 14 });
    map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
    map.addLayer({ id: 'sky', type: 'sky', paint: { 'sky-type': 'atmosphere', 'sky-atmosphere-sun': [0,90], 'sky-atmosphere-sun-intensity': 15 } });

    // Load data + build layers
    await loadFacilities();
    addMapLayers();
    populateConditionDropdown();
    checkApiHealth();

    // Intro animation
    setTimeout(() => {
        document.getElementById('loader').classList.add('gone');
        map.flyTo({ center: [-1.0232, 7.9465], zoom: 6.5, pitch: 50, bearing: -15, duration: 4000, essential: true });
    }, 2200);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFacilities() {
    try {
        const resp = await fetch(API_BASE + '/facilities.geojson');
        facilitiesGeoJSON = await resp.json();

        // Compute stats from real data
        const cities = new Set();
        const specs = new Set();
        const allSpecs = [];
        facilitiesGeoJSON.features.forEach(f => {
            const p = f.properties;
            if (p.city) cities.add(p.city);
            try {
                JSON.parse(p.specialties || '[]').forEach(s => { specs.add(s); allSpecs.push(s); });
            } catch(e) {}
        });

        document.getElementById('st-total').textContent = facilitiesGeoJSON.features.length;
        document.getElementById('st-cities').textContent = cities.size;
        document.getElementById('st-specs').textContent = specs.size;

        // Store unique specialties for dropdown
        window._allSpecialties = [...specs].sort();

    } catch (err) {
        console.error('Failed to load facilities.geojson:', err);
    }
}

function populateConditionDropdown() {
    const sel = document.getElementById('inp-condition');
    if (!window._allSpecialties) return;
    window._allSpecialties.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = fmtSpec(s);
        sel.appendChild(opt);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP LAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMapLayers() {
    if (!facilitiesGeoJSON) return;

    map.addSource('facilities', { type: 'geojson', data: facilitiesGeoJSON });

    // Heatmap â€” weighted by specialty count (more specialties = hotter)
    map.addLayer({
        id: 'layer-heatmap', type: 'heatmap', source: 'facilities',
        layout: { visibility: 'none' },
        paint: {
            'heatmap-weight': ['interpolate',['linear'],['length',['to-string',['get','specialties']]],10,0.2,100,0.5,300,1],
            'heatmap-intensity': ['interpolate',['linear'],['zoom'],0,1,9,3],
            'heatmap-radius': ['interpolate',['linear'],['zoom'],0,4,6,30,9,50],
            'heatmap-color': ['interpolate',['linear'],['heatmap-density'],
                0,'rgba(0,0,0,0)',0.1,'rgba(26,5,48,0.6)',0.25,'rgba(107,15,107,0.7)',
                0.4,'rgba(255,68,68,0.8)',0.6,'rgba(255,153,68,0.85)',0.8,'rgba(255,238,68,0.9)',1,'rgba(255,255,255,1)'
            ],
            'heatmap-opacity': ['interpolate',['linear'],['zoom'],5,0.8,12,0.3],
        }
    }, 'waterway-label');

    // Glow layer
    map.addLayer({
        id: 'layer-glow', type: 'circle', source: 'facilities',
        paint: {
            'circle-radius': ['interpolate',['linear'],['zoom'],4,6,8,12,12,18],
            'circle-color': '#FF6B35', 'circle-opacity': 0.15, 'circle-blur': 1,
        }
    });

    // 3D Hospital Models (extruded cylinders)
    map.addLayer({
        id: 'layer-3d-hospitals',
        type: 'fill-extrusion',
        source: 'facilities',
        minzoom: 10,
        paint: {
            'fill-extrusion-color': [
                'interpolate', ['linear'], ['zoom'],
                10, '#FF6B35',
                15, '#FF8F6B'
            ],
            'fill-extrusion-height': [
                'interpolate', ['exponential', 1.5], ['zoom'],
                10, 20,
                14, 80,
                18, 200
            ],
            'fill-extrusion-base': 0,
            'fill-extrusion-opacity': 0.9,
            'fill-extrusion-vertical-gradient': true
        }
    }, 'layer-buildings');
    
    // Markers (flat circles for far zoom)
    map.addLayer({
        id: 'layer-markers', type: 'circle', source: 'facilities',
        maxzoom: 10,
        paint: {
            'circle-radius': ['interpolate',['linear'],['zoom'],4,2.5,8,5,10,8],
            'circle-color': '#FF6B35', 'circle-opacity': 0.85,
            'circle-stroke-width': ['interpolate',['linear'],['zoom'],4,0.5,10,2],
            'circle-stroke-color': 'rgba(255,255,255,0.6)', 'circle-blur': 0.1,
        }
    });

    // 3D Buildings (from Mapbox vector tiles)
    const labelLayer = map.getStyle().layers.find(l => l.type === 'symbol' && l.layout['text-field']);
    map.addLayer({
        id: 'layer-buildings', source: 'composite', 'source-layer': 'building',
        filter: ['==', 'extrude', 'true'], type: 'fill-extrusion', minzoom: 13,
        layout: { visibility: 'none' },
        paint: {
            'fill-extrusion-color': ['interpolate',['linear'],['get','height'],0,'#1a1a3e',20,'#2a2a5e',50,'#4a3a7e'],
            'fill-extrusion-height': ['interpolate',['linear'],['zoom'],13,0,14.5,['get','height']],
            'fill-extrusion-base': ['interpolate',['linear'],['zoom'],13,0,14.5,['get','min_height']],
            'fill-extrusion-opacity': 0.75,
        }
    }, labelLayer ? labelLayer.id : undefined);

    // Click handlers for both 2D markers and 3D models
    const handleFacilityClick = (e) => {
        const f = e.features[0];
        const lngLat = e.lngLat;
        map.flyTo({ center: lngLat, zoom: Math.max(map.getZoom(), 16), pitch: 60, duration: 1500 });
        if (!layerState.buildings) toggleLayer('buildings');
        // showDetail triggers 3D model + narration
        showDetail(f.properties, lngLat);
    };
    
    map.on('click', 'layer-markers', handleFacilityClick);
    map.on('click', 'layer-3d-hospitals', handleFacilityClick);

    map.on('mouseenter', 'layer-markers', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'layer-markers', () => { map.getCanvas().style.cursor = ''; });
    map.on('mouseenter', 'layer-3d-hospitals', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'layer-3d-hospitals', () => { map.getCanvas().style.cursor = ''; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH â€” calls the REAL API (which calls real MCP tools)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSearch() {
    const condition = document.getElementById('inp-condition').value;
    const location  = document.getElementById('inp-location').value.trim();
    const radius    = parseInt(document.getElementById('inp-radius').value);

    if (!condition) return alert('Select a condition first');

    const btn = document.getElementById('btn-search');
    btn.disabled = true;
    btn.innerHTML = 'âŸ³ Querying toolsâ€¦';

    try {
        const url = `${API_BASE}/api/search?` + new URLSearchParams({
            condition, location, radius_km: radius, limit: 20
        });
        const resp = await fetch(url);
        const json = await resp.json();

        if (!json.success) throw new Error(json.error || 'Tool returned error');

        const data = json.data;
        console.log(`âœ… ${json.tool} returned ${data.total_found} results in ${json.elapsed_ms}ms`);

        // Build result features from real tool output
        const results = data.facilities.map(f => ({
            coords: [f.lng, f.lat],
            distance: f.distance_km,
            name: f.name,
            city: f.city,
            region: f.region,
            facility_type: f.facility_type,
            specialties: f.specialties,
            equipment: f.equipment,
            capability: f.capability,
        }));

        searchResultsCache = results;
        renderResults(results, condition, data.total_found);

        // Fly to search center
        const ctr = [data.center.lng, data.center.lat];
        map.flyTo({ center: ctr, zoom: 8, pitch: 45, duration: 2000 });
        drawRadius(ctr, radius);
        
        // Replace map with ONLY filtered results
        replaceMapWithResults(results);
        highlightResults(results);
        
        // Update stats
        document.getElementById('st-total').textContent = data.total_found;

    } catch (err) {
        console.error('Search failed:', err);
        showApiStatus(`Search failed: ${err.message}`, false);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>âš¡</span> Find Facilities';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COVERAGE GAPS â€” calls the REAL API (find_coverage_gaps tool)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doGaps() {
    const condition = document.getElementById('inp-condition').value;
    if (!condition) return alert('Select a condition first');

    const btn = document.getElementById('btn-gaps');
    btn.disabled = true;
    btn.innerHTML = 'âŸ³ Scanningâ€¦';

    try {
        const url = `${API_BASE}/api/gaps?` + new URLSearchParams({
            specialty: condition, min_gap_km: 50, limit: 15
        });
        const resp = await fetch(url);
        const json = await resp.json();

        if (!json.success) throw new Error(json.error || 'Tool returned error');

        const data = json.data;
        console.log(`âœ… ${json.tool} found ${data.gap_count} gaps in ${json.elapsed_ms}ms`);

        // Show gaps on map
        renderDesertGaps(data.gaps);
        showApiStatus(`Found ${data.gap_count} coverage gaps for ${fmtSpec(condition)}`, true);

    } catch (err) {
        console.error('Coverage gap search failed:', err);
        showApiStatus(`Gaps failed: ${err.message}`, false);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>ğŸœï¸</span> Find Medical Deserts';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(results, condition, totalFromTool) {
    const section = document.getElementById('results-section');
    const list = document.getElementById('results-list');
    const label = document.getElementById('results-label');

    section.style.display = 'block';
    label.textContent = `${totalFromTool} found â€” ${fmtSpec(condition)}`;

    if (results.length === 0) {
        list.innerHTML = `<div style="text-align:center;padding:20px;color:var(--t3);"><div style="font-size:32px;margin-bottom:8px;">ğŸœï¸</div><div>No facilities found</div><div style="font-size:11px;margin-top:4px;">Try a larger radius</div></div>`;
        return;
    }

    list.innerHTML = results.slice(0, 10).map((r, i) => {
        let specs = [];
        try { specs = JSON.parse(r.specialties || '[]'); } catch(e){}
        const score = Math.min(99, Math.round(85 - r.distance * 0.3 + Math.min(15, specs.length * 2)));
        const color = score > 80 ? 'var(--green)' : score > 50 ? 'var(--accent)' : 'var(--yellow)';
        const bar = score > 80 ? 'linear-gradient(90deg,#00E676,#69F0AE)' : score > 50 ? 'linear-gradient(90deg,#FF6B35,#FF8F6B)' : 'linear-gradient(90deg,#FFD740,#FFE57F)';

        return `
            <div class="result-card" id="rc-${i}" onclick="selectResult(${i})">
                <div class="rank">${i+1}</div>
                <div class="name">${r.name}</div>
                <div class="meta">
                    <span>ğŸ“ ${r.distance.toFixed(1)} km</span>
                    <span>ğŸ¥ ${r.facility_type || 'â€”'}</span>
                    <span>ğŸ™ï¸ ${r.city || 'â€”'}</span>
                </div>
                <div class="match-label"><span>Relevance</span><span style="color:${color}">${score}%</span></div>
                <div class="match-bar"><div class="match-fill" style="width:${score}%;background:${bar};"></div></div>
                ${specs.length ? `<div class="tags">${specs.slice(0,4).map(s=>`<span class="tag">${fmtSpec(s)}</span>`).join('')}${specs.length>4?`<span class="tag">+${specs.length-4}</span>`:''}</div>` : ''}
            </div>`;
    }).join('');
}

function selectResult(i) {
    document.querySelectorAll('.result-card').forEach(c => c.classList.remove('active'));
    document.getElementById(`rc-${i}`).classList.add('active');
    const r = searchResultsCache[i];
    if (!r) return;
    const lngLat = { lng: r.coords[0], lat: r.coords[1] };
    map.flyTo({ center: r.coords, zoom: 16, pitch: 60, bearing: Math.random()*60-30, duration: 2000 });
    if (!layerState.buildings) toggleLayer('buildings');
    showDetail(r, lngLat);
}

function replaceMapWithResults(results) {
    // Build GeoJSON from search results ONLY
    const filteredGeoJSON = {
        type: 'FeatureCollection',
        features: results.map(r => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: r.coords },
            properties: {
                name: r.name,
                city: r.city,
                region: r.region,
                facility_type: r.facility_type,
                specialties: r.specialties,
                equipment: r.equipment,
                capability: r.capability,
                distance: r.distance,
            }
        }))
    };
    
    // Update the map source to show ONLY these facilities
    map.getSource('facilities').setData(filteredGeoJSON);
}

function resetMapToAllFacilities() {
    // Restore all facilities
    if (facilitiesGeoJSON) {
        map.getSource('facilities').setData(facilitiesGeoJSON);
    }
}

function highlightResults(results) {
    activeMarkers.forEach(m => m.remove());
    activeMarkers = [];
    results.slice(0, 10).forEach((r, i) => {
        const el = document.createElement('div');
        el.style.cssText = `width:${i===0?18:14}px;height:${i===0?18:14}px;border-radius:50%;background:${i===0?'var(--green)':'var(--accent)'};border:2px solid rgba(255,255,255,0.8);cursor:pointer;box-shadow:0 0 12px ${i===0?'rgba(0,230,118,0.6)':'var(--accent-glow)'};`;
        activeMarkers.push(new mapboxgl.Marker(el).setLngLat(r.coords).addTo(map));
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER COVERAGE GAPS (from real tool)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDesertGaps(gaps) {
    // Remove old layer
    if (map.getSource('desert-gaps')) {
        if (map.getLayer('desert-circles')) map.removeLayer('desert-circles');
        if (map.getLayer('desert-labels')) map.removeLayer('desert-labels');
        map.removeSource('desert-gaps');
    }

    const features = gaps.map(g => ({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [g.lng, g.lat] },
        properties: {
            nearest_city: g.nearest_city,
            distance_km: g.nearest_facility_distance_km,
            severity: g.severity,
            nearest_facility: g.nearest_facility_name,
        }
    }));

    map.addSource('desert-gaps', { type: 'geojson', data: { type: 'FeatureCollection', features } });

    map.addLayer({
        id: 'desert-circles', type: 'circle', source: 'desert-gaps',
        paint: {
            'circle-radius': ['interpolate',['linear'],['zoom'],4,20,8,40,12,60],
            'circle-color': ['case', ['==',['get','severity'],'critical'], 'rgba(255,82,82,0.25)', 'rgba(255,152,0,0.2)'],
            'circle-blur': 0.6,
            'circle-stroke-width': 2,
            'circle-stroke-color': ['case', ['==',['get','severity'],'critical'], 'rgba(255,82,82,0.5)', 'rgba(255,152,0,0.4)'],
        }
    }, 'layer-glow');

    map.addLayer({
        id: 'desert-labels', type: 'symbol', source: 'desert-gaps',
        layout: {
            'text-field': ['concat', 'DESERT\n', ['get','nearest_city']],
            'text-size': 10, 'text-anchor': 'center',
        },
        paint: { 'text-color': '#FF5252', 'text-halo-color': '#000', 'text-halo-width': 1 },
    });

    // Fly to see all gaps
    if (gaps.length > 0) {
        const bounds = new mapboxgl.LngLatBounds();
        gaps.forEach(g => bounds.extend([g.lng, g.lat]));
        map.fitBounds(bounds, { padding: 80, pitch: 30, duration: 2000 });
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDetail(props, lngLat) {
    document.getElementById('d-name').textContent = props.name || 'â€”';
    document.getElementById('d-type').textContent = props.facility_type || 'Facility';

    let specs = [];
    try { specs = JSON.parse(props.specialties || '[]'); } catch(e){}
    document.getElementById('d-specs').textContent = specs.length;
    document.getElementById('d-dist').textContent = props.distance != null ? props.distance.toFixed(1) + ' km' : 'â€”';
    document.getElementById('d-city').textContent = props.city || 'â€”';

    let equip = [];
    try { equip = JSON.parse(props.equipment || '[]').filter(Boolean); } catch(e){}
    const chips = [...specs.map(fmtSpec), ...equip];
    document.getElementById('d-caps').innerHTML = chips.slice(0,12).map(c => `<span class="cap-chip">${c}</span>`).join('') + (chips.length > 12 ? `<span class="cap-chip">+${chips.length-12}</span>` : '');

    document.getElementById('detail-card').classList.add('show');
    
    // Add 3D hospital model at facility location
    const coords = lngLat ? [lngLat.lng, lngLat.lat] : (props.coords || [0, 0]);
    add3DHospitalModel(coords, props.name || 'Hospital');
    
    // Narrate with ElevenLabs
    narrateFacility(props);
}

function closeDetail() { 
    document.getElementById('detail-card').classList.remove('show'); 
    // Remove 3D model
    if (current3DModel && map.getLayer(current3DModel)) {
        map.removeLayer(current3DModel);
        current3DModel = null;
    }
    // Stop audio
    if (audioElement) {
        audioElement.pause();
        audioElement = null;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LAYER TOGGLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleLayer(name) {
    layerState[name] = !layerState[name];
    const on = layerState[name];
    document.getElementById(`tog-${name}`).classList.toggle('on', on);

    switch(name) {
        case 'markers':
            map.setLayoutProperty('layer-markers', 'visibility', on ? 'visible' : 'none');
            map.setLayoutProperty('layer-3d-hospitals', 'visibility', on ? 'visible' : 'none');
            map.setLayoutProperty('layer-glow', 'visibility', on ? 'visible' : 'none');
            break;
        case 'heatmap':
            map.setLayoutProperty('layer-heatmap', 'visibility', on ? 'visible' : 'none');
            document.getElementById('heatmap-legend').classList.toggle('show', on);
            break;
        case 'buildings':
            map.setLayoutProperty('layer-buildings', 'visibility', on ? 'visible' : 'none');
            break;
        case 'deserts':
            if (map.getLayer('desert-circles')) {
                map.setLayoutProperty('desert-circles', 'visibility', on ? 'visible' : 'none');
                map.setLayoutProperty('desert-labels', 'visibility', on ? 'visible' : 'none');
            } else if (on) {
                // If no gaps loaded yet, trigger the tool
                doGaps();
            }
            break;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH RADIUS CIRCLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawRadius(center, km) {
    if (map.getSource('search-radius')) {
        map.removeLayer('radius-fill');
        map.removeLayer('radius-line');
        map.removeSource('search-radius');
    }
    const pts = 64, coords = [];
    for (let i = 0; i <= pts; i++) {
        const a = (i / pts) * 2 * Math.PI;
        const dx = km / 111.32 * Math.cos(a);
        const dy = km / (111.32 * Math.cos(center[1] * Math.PI / 180)) * Math.sin(a);
        coords.push([center[0] + dy, center[1] + dx]);
    }
    map.addSource('search-radius', { type: 'geojson', data: { type: 'Feature', geometry: { type: 'Polygon', coordinates: [coords] } } });
    map.addLayer({ id: 'radius-fill', type: 'fill', source: 'search-radius', paint: { 'fill-color': 'rgba(0,212,255,0.06)' } }, 'layer-glow');
    map.addLayer({ id: 'radius-line', type: 'line', source: 'search-radius', paint: { 'line-color': 'rgba(0,212,255,0.4)', 'line-width': 2, 'line-dasharray': [3,3] } });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function flyTo(lng, lat, zoom, name) {
    map.flyTo({ center: [lng, lat], zoom, pitch: 60, bearing: -15, duration: 2500 });
    if (!layerState.buildings) toggleLayer('buildings');
}

function resetGlobe() {
    closeDetail();
    resetMapToAllFacilities();
    
    // Clear search results
    document.getElementById('results-section').style.display = 'none';
    activeMarkers.forEach(m => m.remove());
    activeMarkers = [];
    searchResultsCache = [];
    
    // Remove search radius
    if (map.getSource('search-radius')) {
        map.removeLayer('radius-fill');
        map.removeLayer('radius-line');
        map.removeSource('search-radius');
    }
    
    // Restore stats
    if (facilitiesGeoJSON) {
        document.getElementById('st-total').textContent = facilitiesGeoJSON.features.length;
    }
    
    map.flyTo({ center: [-1.0232, 7.9465], zoom: 6.5, pitch: 45, bearing: -15, duration: 3000 });
    if (layerState.buildings) toggleLayer('buildings');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtSpec(s) { return s.replace(/([A-Z])/g, ' $1').replace(/^./, c => c.toUpperCase()).trim(); }

document.getElementById('inp-radius').addEventListener('input', e => {
    document.getElementById('radius-display').textContent = e.target.value + ' km';
});

// Auto-show buildings on deep zoom
map.on('zoom', () => { if (map.getZoom() >= 14 && !layerState.buildings) toggleLayer('buildings'); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3D HOSPITAL MODEL (three.js) â€” Modern multi-story hospital
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function add3DHospitalModel(coords, name) {
    console.log('ğŸ¥ Adding 3D hospital model at:', coords, name);
    
    if (!window.THREE) { console.error('âŒ THREE.js not loaded!'); return; }
    
    // Remove old model layer
    if (current3DModel && map.getLayer(current3DModel)) {
        map.removeLayer(current3DModel);
    }
    
    const merc = mapboxgl.MercatorCoordinate.fromLngLat(coords, 0);
    const modelTransform = {
        translateX: merc.x, translateY: merc.y, translateZ: merc.z,
        rotateX: Math.PI / 2, rotateY: 0, rotateZ: 0,
        scale: merc.meterInMercatorCoordinateUnits()
    };
    
    const THREE = window.THREE;
    const layerId = '3d-model-hospital';
    current3DModel = layerId;
    
    const customLayer = {
        id: layerId, type: 'custom', renderingMode: '3d',
        onAdd: function (map, gl) {
            this.camera = new THREE.Camera();
            this.scene = new THREE.Scene();
            this.clock = new THREE.Clock();
            
            // Lighting
            this.scene.add(new THREE.AmbientLight(0xccddff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 1.0);
            sun.position.set(50, -80, 120);
            this.scene.add(sun);
            const fill = new THREE.DirectionalLight(0x8899cc, 0.4);
            fill.position.set(-40, 60, 80);
            this.scene.add(fill);
            
            // â”€â”€ Materials â”€â”€
            const wallMat = new THREE.MeshPhongMaterial({ color: 0xf0f0f0, specular: 0x222222, shininess: 30 });
            const glassMat = new THREE.MeshPhongMaterial({ color: 0x88ccff, specular: 0xffffff, shininess: 100, opacity: 0.6, transparent: true });
            const accentMat = new THREE.MeshPhongMaterial({ color: 0xFF6B35, specular: 0xff8855, shininess: 60 });
            const crossMat = new THREE.MeshPhongMaterial({ color: 0xff0000, emissive: 0xff2200, emissiveIntensity: 0.5 });
            const roofMat = new THREE.MeshPhongMaterial({ color: 0x445566 });
            const padMat = new THREE.MeshPhongMaterial({ color: 0x334455 });
            
            const hospital = new THREE.Group();
            
            // â”€â”€ Main building (60Ã—30Ã—40m, 5 floors) â”€â”€
            const mainBody = new THREE.Mesh(new THREE.BoxGeometry(60, 30, 40), wallMat);
            mainBody.position.set(0, 0, 20);
            hospital.add(mainBody);
            
            // â”€â”€ Glass window strips per floor â”€â”€
            for (let f = 0; f < 5; f++) {
                const z = 5 + f * 8;
                // Front windows
                const winF = new THREE.Mesh(new THREE.BoxGeometry(56, 0.5, 4), glassMat);
                winF.position.set(0, -15.3, z);
                hospital.add(winF);
                // Back windows
                const winB = new THREE.Mesh(new THREE.BoxGeometry(56, 0.5, 4), glassMat);
                winB.position.set(0, 15.3, z);
                hospital.add(winB);
                // Side windows
                const winL = new THREE.Mesh(new THREE.BoxGeometry(0.5, 26, 4), glassMat);
                winL.position.set(-30.3, 0, z);
                hospital.add(winL);
                const winR = new THREE.Mesh(new THREE.BoxGeometry(0.5, 26, 4), glassMat);
                winR.position.set(30.3, 0, z);
                hospital.add(winR);
            }
            
            // â”€â”€ Side wings (smaller, 2 floors each) â”€â”€
            const wingGeo = new THREE.BoxGeometry(20, 20, 16);
            const wingL = new THREE.Mesh(wingGeo, wallMat);
            wingL.position.set(-40, 0, 8);
            hospital.add(wingL);
            const wingR = new THREE.Mesh(wingGeo, wallMat);
            wingR.position.set(40, 0, 8);
            hospital.add(wingR);
            
            // Wing glass
            for (let f = 0; f < 2; f++) {
                const z = 3 + f * 8;
                [wingL, wingR].forEach(w => {
                    const wg = new THREE.Mesh(new THREE.BoxGeometry(18, 0.5, 3), glassMat);
                    wg.position.set(w.position.x, w.position.y - 10.3, z);
                    hospital.add(wg);
                });
            }
            
            // â”€â”€ Accent stripe along top â”€â”€
            const stripe = new THREE.Mesh(new THREE.BoxGeometry(62, 31, 2), accentMat);
            stripe.position.set(0, 0, 41);
            hospital.add(stripe);
            
            // â”€â”€ Roof â”€â”€
            const roof = new THREE.Mesh(new THREE.BoxGeometry(64, 33, 1), roofMat);
            roof.position.set(0, 0, 42);
            hospital.add(roof);
            
            // â”€â”€ Helipad on roof â”€â”€
            const padCircle = new THREE.Mesh(new THREE.CylinderGeometry(8, 8, 0.3, 32), padMat);
            padCircle.rotation.x = Math.PI / 2;
            padCircle.position.set(0, 0, 42.5);
            hospital.add(padCircle);
            // H marking
            const hMat = new THREE.MeshPhongMaterial({ color: 0xffffff });
            const hLeft = new THREE.Mesh(new THREE.BoxGeometry(1, 6, 0.2), hMat);
            hLeft.position.set(-2, 0, 42.8);
            hospital.add(hLeft);
            const hRight = new THREE.Mesh(new THREE.BoxGeometry(1, 6, 0.2), hMat);
            hRight.position.set(2, 0, 42.8);
            hospital.add(hRight);
            const hMid = new THREE.Mesh(new THREE.BoxGeometry(5, 1, 0.2), hMat);
            hMid.position.set(0, 0, 42.8);
            hospital.add(hMid);
            
            // â”€â”€ Entrance canopy â”€â”€
            const canopy = new THREE.Mesh(new THREE.BoxGeometry(16, 8, 1), accentMat);
            canopy.position.set(0, -19, 10);
            hospital.add(canopy);
            
            // â”€â”€ Red cross sign on entrance â”€â”€
            const cH = new THREE.Mesh(new THREE.BoxGeometry(8, 0.5, 2), crossMat);
            cH.position.set(0, -15.5, 22);
            hospital.add(cH);
            const cV = new THREE.Mesh(new THREE.BoxGeometry(2, 0.5, 8), crossMat);
            cV.position.set(0, -15.5, 22);
            hospital.add(cV);
            
            // â”€â”€ Pulsing beacon on roof â”€â”€
            this.beacon = new THREE.PointLight(0xff0000, 2, 200);
            this.beacon.position.set(0, 0, 48);
            hospital.add(this.beacon);
            
            // â”€â”€ Ground pad â”€â”€
            const ground = new THREE.Mesh(new THREE.BoxGeometry(100, 60, 0.5), new THREE.MeshPhongMaterial({ color: 0x445544 }));
            ground.position.set(0, 0, -0.25);
            hospital.add(ground);
            
            this.scene.add(hospital);
            
            this.map = map;
            this.renderer = new THREE.WebGLRenderer({ canvas: map.getCanvas(), context: gl, antialias: true });
            this.renderer.autoClear = false;
        },
        render: function (gl, matrix) {
            // Pulse the beacon
            if (this.beacon && this.clock) {
                const t = this.clock.getElapsedTime();
                this.beacon.intensity = 1 + Math.sin(t * 3) * 1.5;
            }
            
            const THREE = window.THREE;
            const rX = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(1,0,0), modelTransform.rotateX);
            const rY = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0,1,0), modelTransform.rotateY);
            const rZ = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0,0,1), modelTransform.rotateZ);
            
            const m = new THREE.Matrix4().fromArray(matrix);
            const l = new THREE.Matrix4()
                .makeTranslation(modelTransform.translateX, modelTransform.translateY, modelTransform.translateZ)
                .scale(new THREE.Vector3(modelTransform.scale, -modelTransform.scale, modelTransform.scale))
                .multiply(rX).multiply(rY).multiply(rZ);
            
            this.camera.projectionMatrix = m.multiply(l);
            this.renderer.resetState();
            this.renderer.render(this.scene, this.camera);
            this.map.triggerRepaint();
        }
    };
    
    map.addLayer(customLayer);
    console.log('âœ… 3D hospital model layer added:', name);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ELEVENLABS NARRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function narrateFacility(props) {
    console.log('ğŸ”Š Starting ElevenLabs narration for:', props.name);
    
    // Stop previous audio
    if (audioElement) {
        audioElement.pause();
        audioElement = null;
    }
    
    if (!ELEVENLABS_API_KEY || ELEVENLABS_API_KEY === 'YOUR_ELEVENLABS_API_KEY') {
        console.log('âš ï¸ ElevenLabs API key not set');
        return;
    }
    
    // Build narration text
    let specs = [];
    try { specs = JSON.parse(props.specialties || '[]'); } catch(e) {}
    
    const text = `${props.name || 'This facility'}. ${props.city ? 'Located in ' + props.city + '.' : ''} ${
        specs.length > 0 ? 'Specialties include ' + specs.slice(0, 3).map(s => s.replace(/([A-Z])/g, ' $1')).join(', ') + '.' : ''
    }`;
    
    try {
        const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/21m00Tcm4TlvDq8ikWAM', {
            method: 'POST',
            headers: {
                'Accept': 'audio/mpeg',
                'Content-Type': 'application/json',
                'xi-api-key': ELEVENLABS_API_KEY
            },
            body: JSON.stringify({
                text: text,
                model_id: 'eleven_monolingual_v1',
                voice_settings: {
                    stability: 0.5,
                    similarity_boost: 0.5
                }
            })
        });
        
        if (response.ok) {
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            audioElement = new Audio(audioUrl);
            audioElement.play();
            console.log('âœ… ElevenLabs audio playing');
        } else {
            console.error('âŒ ElevenLabs API error:', response.status, await response.text());
        }
    } catch (err) {
        console.error('âŒ ElevenLabs error:', err);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HEALTH CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkApiHealth() {
    try {
        const r = await fetch(API_BASE + '/api/health');
        const j = await r.json();
        if (j.status === 'ok') {
            showApiStatus(`Connected â€” dataset: ${j.dataset}`, true);
            document.getElementById('status-dot').style.background = 'var(--green)';
        } else {
            throw new Error(j.error);
        }
    } catch (e) {
        showApiStatus('API not connected â€” run: python map_api.py', false);
        document.getElementById('status-dot').style.background = 'var(--red)';
    }
}

function showApiStatus(msg, ok) {
    const el = document.getElementById('api-status');
    el.textContent = (ok ? 'âœ… ' : 'âš ï¸ ') + msg;
    el.className = `api-status glass show ${ok ? 'ok' : 'err'}`;
    setTimeout(() => { el.classList.remove('show'); }, 5000);
}
</script>
</body>
</html>
